trigger:
- main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  runtimeIdentifier: 'win-x64'

  # Update if your service connection name differs.
  azureServiceConnection: 'sc-artifact-signing'

  # Set these as pipeline variables or in a variable group.
  # If you set keyVaultName (or Terraform provides it via variable group),
  # the AzureKeyVault@2 task below will populate the artifactSigning* variables.
  keyVaultName: ''
  artifactSigningEndpoint: ''
  artifactSigningAccountName: ''
  artifactSigningCertificateProfileName: ''
  artifactSigningIdentityValidationId: ''
  artifactSigningResourceGroupName: ''
  artifactSigningCertificateProfileType: 'PublicTrust'
  adoServicePrincipalObjectId: ''

steps:
- task: DotNetCoreCLI@2
  displayName: Publish (unsigned)
  inputs:
    command: publish
    projects: '**/SigningDemo.csproj'
    arguments: '-c $(buildConfiguration) -r $(runtimeIdentifier) --self-contained false'

- task: AzureKeyVault@2
  displayName: Load signing variables from Key Vault
  condition: and(succeeded(), ne(variables['keyVaultName'], ''))
  inputs:
    azureSubscription: '$(azureServiceConnection)'
    KeyVaultName: '$(keyVaultName)'
    SecretsFilter: 'artifactSigningEndpoint,artifactSigningAccountName,artifactSigningCertificateProfileName,artifactSigningIdentityValidationId'
    RunAsPreJob: false

- task: AzureCLI@2
  displayName: Sign with Azure Artifact Signing (SignTool + dlib)
  inputs:
    azureSubscription: '$(azureServiceConnection)'
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      $ErrorActionPreference = 'Stop'

      function Get-Trimmed([string]$value) {
        if ($null -eq $value) { return '' }
        return $value.Trim()
      }

      $rg = Get-Trimmed "$(artifactSigningResourceGroupName)"
      if ([string]::IsNullOrWhiteSpace($rg)) { throw "Missing variable: artifactSigningResourceGroupName" }

      $accountName = Get-Trimmed "$(artifactSigningAccountName)"
      $profileName = Get-Trimmed "$(artifactSigningCertificateProfileName)"
      $profileType = Get-Trimmed "$(artifactSigningCertificateProfileType)"
      if ([string]::IsNullOrWhiteSpace($profileType)) { $profileType = 'PublicTrust' }

      if ([string]::IsNullOrWhiteSpace("$(artifactSigningEndpoint)")) { throw "Missing variable: artifactSigningEndpoint" }
      if ([string]::IsNullOrWhiteSpace($accountName)) { throw "Missing variable: artifactSigningAccountName" }
      if ([string]::IsNullOrWhiteSpace($profileName)) { throw "Missing variable: artifactSigningCertificateProfileName" }

      $identityValidationId = Get-Trimmed "$(artifactSigningIdentityValidationId)"

      $subId = (az account show --query id -o tsv)
      if ([string]::IsNullOrWhiteSpace($subId)) { throw "Unable to determine subscription id from AzureCLI context." }

      $profileResourceId = "/subscriptions/$subId/resourceGroups/$rg/providers/Microsoft.CodeSigning/codeSigningAccounts/$accountName/certificateProfiles/$profileName"
      $profileUrl = "https://management.azure.com$profileResourceId?api-version=2025-10-13"

      Write-Host "Ensuring certificate profile exists: $profileResourceId"

      $profileExists = $false
      try {
        az rest --method get --url $profileUrl --only-show-errors | Out-Null
        $profileExists = $true
      } catch {
        $profileExists = $false
      }

      if (-not $profileExists) {
        if ([string]::IsNullOrWhiteSpace($identityValidationId)) {
          throw "Certificate profile is missing. Complete identity validation in the portal and set Key Vault secret 'artifactSigningIdentityValidationId' (or set pipeline variable artifactSigningIdentityValidationId)."
        }

        $body = @{
          properties = @{
            identityValidationId   = $identityValidationId
            profileType           = $profileType
            includeStreetAddress  = $false
            includePostalCode     = $false
          }
        } | ConvertTo-Json -Depth 10

        az rest --method put --url $profileUrl --body $body --only-show-errors | Out-Null
        Write-Host "Created certificate profile: $profileName"
      }

      $spObjectId = Get-Trimmed "$(adoServicePrincipalObjectId)"
      if (-not [string]::IsNullOrWhiteSpace($spObjectId)) {
        $roleName = "Artifact Signing Certificate Profile Signer"
        Write-Host "Ensuring RBAC role '$roleName' on profile for SP object id $spObjectId"
        try {
          az role assignment create --assignee-object-id $spObjectId --assignee-principal-type ServicePrincipal --role $roleName --scope $profileResourceId --only-show-errors | Out-Null
        } catch {
          Write-Host "Role assignment may already exist; continuing."
        }
      }

      az account show --output table

      $tempRoot = Join-Path "$(Agent.TempDirectory)" "artifact-signing"
      New-Item -ItemType Directory -Force -Path $tempRoot | Out-Null

      $nugetExe = Join-Path $tempRoot "nuget.exe"
      Invoke-WebRequest -Uri https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -OutFile $nugetExe

      $sdkOut = Join-Path $tempRoot "sdk"
      & $nugetExe install Microsoft.Windows.SDK.BuildTools -x -OutputDirectory $sdkOut | Out-Host

      $signtool = Get-ChildItem -Path $sdkOut -Recurse -Filter signtool.exe | Where-Object { $_.FullName -match "\\x64\\signtool\\.exe$" } | Select-Object -First 1
      if (-not $signtool) {
        $signtool = Get-ChildItem -Path $sdkOut -Recurse -Filter signtool.exe | Where-Object { $_.FullName -match "\\x64\\signtool\\.exe" } | Select-Object -First 1
      }
      if (-not $signtool) { throw "signtool.exe not found after extracting Microsoft.Windows.SDK.BuildTools" }

      $dlibOut = Join-Path $tempRoot "dlib"
      & $nugetExe install Microsoft.ArtifactSigning.Client -x -OutputDirectory $dlibOut | Out-Host

      $dlib = Get-ChildItem -Path $dlibOut -Recurse -Filter Azure.CodeSigning.Dlib.dll | Where-Object { $_.FullName -match "\\x64\\Azure\\.CodeSigning\\.Dlib\\.dll$" } | Select-Object -First 1
      if (-not $dlib) {
        $dlib = Get-ChildItem -Path $dlibOut -Recurse -Filter Azure.CodeSigning.Dlib.dll | Select-Object -First 1
      }
      if (-not $dlib) { throw "Azure.CodeSigning.Dlib.dll not found after extracting Microsoft.ArtifactSigning.Client" }

      $metadataPath = Join-Path $tempRoot "metadata.json"
      $metadata = @{
        Endpoint               = "$(artifactSigningEndpoint)"
        CodeSigningAccountName = "$(artifactSigningAccountName)"
        CertificateProfileName = "$(artifactSigningCertificateProfileName)"
        CorrelationId          = "build-$(Build.BuildId)"
      } | ConvertTo-Json -Depth 4

      $metadata | Out-File -FilePath $metadataPath -Encoding utf8

      $unsigned = "$(Build.SourcesDirectory)\SigningDemo\bin\$(buildConfiguration)\net8.0\$(runtimeIdentifier)\publish\SigningDemo.exe"
      if (-not (Test-Path $unsigned)) { throw "Unsigned binary not found at $unsigned" }

      $signedDir = "$(Build.ArtifactStagingDirectory)"
      New-Item -ItemType Directory -Force -Path $signedDir | Out-Null
      $signed = Join-Path $signedDir "SigningDemo.signed.exe"
      Copy-Item $unsigned $signed -Force

      Write-Host "Using signtool: $($signtool.FullName)"
      Write-Host "Using dlib: $($dlib.FullName)"

      & $signtool.FullName sign /v /debug /fd SHA256 /tr "http://timestamp.acs.microsoft.com" /td SHA256 /dlib "$($dlib.FullName)" /dmdf "$metadataPath" "$signed"

- powershell: |
    $ErrorActionPreference = 'Stop'
    $signed = "$(Build.ArtifactStagingDirectory)\SigningDemo.signed.exe"
    Get-AuthenticodeSignature $signed | Format-List
  displayName: Verify signature

- task: PublishBuildArtifacts@1
  displayName: Publish signed artifact
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'signed-drop'
